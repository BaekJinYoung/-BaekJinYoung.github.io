---
title: 오류
author: Baek JinYoung
date: 2024-08-02
category: Jekyll
layout: post
---

Ubuntu/Linux Laravel 오류 file_put_contents(/home/ubuntu/laravel/storage/framework/views/파일명.php): Failed to open stream: Permission denied
-

file_put_contents(/home/ubuntu/laravel/storage/framework/views/422980e11385b9e2d7a05e06e6accea1.php): Failed to open stream: Permission denied

<center><img src="https://github.com/user-attachments/assets/bcf7d520-bbec-435c-aaea-bb5cedbd10ae"></center>

PHP의 file_put_contents() 함수가 파일을 생성하거나 쓸 수 없다는 오류가 발생했다.
PHP 프로세스가 /home/사용자/프로젝트명/storage/framework/views/ 디렉토리 또는 그 하위 파일에 접근할 권한이 없다는 의미이다.
Laravel 애플리케이션에서 뷰 캐시 파일을 사용하려는데 해당 파일에 쓰기 권한이 없을 때 주로 나타난다.

오류 원인으로는 이하 세가지가 있다.

1. 디렉토리 권한 문제
해당 디렉토리의 권한이 웹 서버 사용자(예: www-data, apache, nginx 등)에게 쓰기 권한을 부여하지 않았을 경우.

2. 소유자 문제
디렉토리의 소유자가 웹 서버 사용자와 일치하지 않을 경우.

3. 잘못된 파일 시스템 설정
특정 서버 설정에서 파일 시스템 접근에 제한을 두고 있을 경우.

해결 방법 요약
```bash
# 프로젝트 디렉토리로 이동
cd /home/ubuntu/laravel

# storage 및 bootstrap/cache 디렉토리에 쓰기 권한 설정 
sudo chmod -R 775 storage bootstrap/cache

# 웹 서버 사용자에게 소유권 변경
sudo chown -R www-data:www-data storage bootstrap/cache

# 사용자와 그룹 권한을 웹 서버 사용자로 변경
sudo chown -R www-data:www-data .

# 파일 및 디렉토리 권한 설정
sudo find . -type f -exec chmod 644 {} \;
sudo find . -type d -exec chmod 755 {} \;

# storage와 bootstrap/cache 디렉토리에 쓰기 권한 설정
sudo chmod -R 775 storage bootstrap/cache

# 캐시 정리
php artisan cache:clear
php artisan config:cache
php artisan route:clear
php artisan view:clear
php artisan config:cache

# nginx 재시작
sudo systemctl restart nginx 
```

1. 에러가 발생한 프로젝트 디렉토리로 이동한다.

예시의 laravel은 내가 만든 프로젝트 디렉토리 이름이다.

```bash
cd /home/사용자/프로젝트명

cd /home/ubuntu/laravel
```

'cd'
'cd'는 'Change Directory'의 약자로, 현재 작업 중인 디렉토리를 변경하는 데 사용한다.
이 명령어 뒤에 지정된 경로로 이동한다.

'/home/ubuntu/laravel'
이동할 디렉토리의 절대 경로이다.
해당 디렉토리가 존재해야 이동할 수 있다.

'/'
'/'는 루트 디렉토리를 의미한다.
루트 디렉토리는 모든 파일 및 디렉토리의 최상위 레벨로, 시스템의 기본 시작점이다.

'home'
루트 디렉토리 아래의 디렉토리로, 일반적으로 사용자 계정의 홈 디렉토리를 포함한다.
home은 여러 사용자의 홈 디렉토리를 포함할 수 있다.

'ubuntu'
특정 사용자 계정의 홈 디렉토리이다.

'laravel'
사용자가 만들었거나 설치한 Laravel 프로젝트 디렉토리이다.
이 디렉토리는 Laravel 애플리케이션의 소스 코드와 관련 파일을 포함한다.

2. storage 및 bootstrap/cache 디렉토리에 쓰기 권한을 설정한다.

```bash
sudo chmod -R 775 storage bootstrap/cache
```

'sudo'
'sudo'는 'superuser do'의 약자로, 관리자 권한으로 명령을 실행하는 데 사용한다.
사용자가 루트 권한으로 명령어를 실행할 수 있게 하여 파일의 소유자나 그룹을 변경하거나, 
시스템 보호를 받는 디렉토리 내 파일 권한을 수정할 때 필요한 권한을 부여한다.

'chmod'
chmod는 'change mode'의 약자로, 파일 또는 디렉토리의 권한을 변경하는 명령어이다.

'-R'
'recursive'의 약자로, 디렉토리 및 하위 디렉토리와 파일을 포함하여 재귀적으로 권한을 설정한다.
이때 재귀적이란, 어떤 것을 설정할 때 자기 자신을 다시 호출하여 작업을 수행하는 것을 뜻한다.
디렉토리 안의 모든 파일과 하위 디렉토리까지 포함하여 소유자와 그룹을 변경한다.

'775'
파일 및 디렉토리 권한을 지정하는 숫자 코드이다.
각 숫자는 차례로 사용자(7), 그룹(7), 다른 사용자(5)에게 부여하는 권한을 나타낸다.
'7': 읽기, 쓰기, 실행
'5': 읽기, 실행

'storage bootstrap/cache'
권한을 설정할 디렉토리의 경로이다.
공백으로 두 경로를 분리했다. 실행하면 'storage' 및 'bootstrap/cache' 디렉토리에 권한이 부여된다.

775 권한을 설정하는 이유
Laravel 애플리케이션의 'storage'와 'bootstrap/chache' 디렉토리는 웹 서버가 세션 데이터, 로그 파일 등을 읽고 쓸 수 있어야 하기 때문에 쓰기 권한을 필요로 한다.

'storage' 디렉토리
'storage/app': 애플리케이션 파일 저장소
'storage/framework': 세션, 캐시, 뷰 파일 저장소
'storage/logs': 애플리케이션 로그 파일 저장소

'bootstrap/cache' 디렉토리는 애플리케이션 부트스트랩 파일과 캐시가 저장되는 디렉토리이다.

3. 웹 서버 사용자에게 소유권 변경

아래 명렁어는 서버 사용자를 'www-data'로 가정하고 소유권을 변경한다.
'www-data'는 Apache나 Nginx가 사용하는 일반적인 사용자 및 그룹이다.
대부분의 Linux 시스템에서 웹 서버는 'www-data' 사용자 및 그룹을 사용한다.
웹 서버 사용자가 apache, nginx 등의 다른 이름일 경우 그에 맞게 조정해야 한다.

```bash
sudo chown -R www-data:www-data storage bootstrap/cache
```

'chown'
'chown'은 'change owner'의 약자로, 파일 또는 디렉토리의 소유자와 그룹을 변경하는 명령어이다.
일반적으로 두 개의 인수를 받는다. 첫 번째 인수는 '소유자:그룹' 형식이고, 두 번재 인수는 파일 또는 디렉토리 경로이다.

'www-data:www-data'
변경할 소유자와 그룹이다. '소유자:그룹' 형식으로 지정한다.

Laravel 애플리케이션에서는 웹 서버가 특정 디렉토리에 대한 읽기 및 쓰기 권한을 가져야 한다.

'storage/framework/sessions': 사용자 세션 데이터 저장
'storage/framework/cache': 캐시 데이터 저장
'storage/logs': 애플리케이션 로그 파일 저장
'storage/app/public': 사용자 업로드 파일 저장
'bootstrap/cache': 뷰 캐시 및 기타 캐시 파일 저장


4. PHP 사용자 확인

웹 서버가 사용하는 PHP 프로세스의 사용자 이름이 맞는지 확인한다.

Nginx 사용자를 확인하는 방법은 다음과 같다.

```bash
ps aux | grep nginx
```

'ps aux'는 시스템에서 실행 중인 프로세스의 정보를 출력하는 데 사용한다.
각 옵션('a', 'u', 'x')은 표시할 정보를 제어하며, 조합하면 모든 프로세스를 포괄적으로 확인할 수 있다.

'| '
'|'는 파이프pipe 연산자로, 앞의 명령어 출력 결과를 다음 명령어의 입력으로 전달한다.

'grep nginx'
전달받은 출력에서 'nginx'라는 문자열을 포함하는 행을 검색하고 필터링한다.


'ps'
'ps'는 'process status'의 약자로, 현재 실행 중인 프로세스 목록을 출력한다.

'aux'
'a'는 'all users'를 의미한다. 터미널에 로그인한 모든 사용자의 프로세스를 보여준다.
기본적으로 'ps' 명령은 현재 사용자와 터미널에 속한 프로세스만 나열하는데, 'a' 옵션을 추가하면 다른 사용자의 프로세스도 포함한다.

'u'는 'user-oriented format'을 의미한다.
CPU 및 메모리 사용량, 프로세스 소유자, 시작 시간 등의 정보를 제공한다.

'x'는 'no controlling terminal'을 의미하며, 터미널에 연결되지 않은 프로세스를 포함한다.
데몬이나 서비스와 같이 백그라운드에서 실행되는 프로세스를 볼 수 있다.

'grep'
'grep'은 'global regular expression print'의 약자로, 텍스트에서 특정 패턴을 검색하고 필터링한다.

'nginx'
검색할 키워드이다. 이 경우 'nginx'라는 문자열을 포함하는 프로세스를 찾는다.


만약 PHP-FPM을 사용하고 있다면, 설정 파일(/etc/php/버전/fpm/pool.d/www.conf)에서 다음과 같은 항목을 찾는다.
나는 php8.2-fpm을 사용한다.

```bash
cd /etc/php/버전/fpm/pool.d/www.conf

cd /etc/php/8.2/fpm/pool.d/www.conf
```

```bash
user = www-data
group = www-data
```

5. Composer 권한 부여
```bash
sudo chown -R www-data:www-data .
```

'.'
'.'은 현재 디렉토리를 나타내는 기호이다.

```bash
sudo find . -type f -exec chmod 644 {} \;
sudo find . -type d -exec chmod 755 {} \;

```
find
파일 및 디렉토리를 검색하는 명령어이다.
지정된 조건에 맞는 파일 또는 디렉토리를 검색하여 후속 명령어로 전달한다.

-type f
'-type f' 옵션은 'find' 명령어에 사용되어 일반 파일regular file만을 검색하도록 지정한다.

'-type d'
'-type d' 옵션은 'find' 명령어가 디렉토리만을 검색하도록 지정한다.

-exec
'-exec' 옵션은 'find' 명령어에 사용되어검색된 결과에 대해 반복적으로 명령어를 수행하여 각각의 대상에 대해 특정 작업을 실행한다.

644
6: 소유자owner에게 읽기와 쓰기 권한을 부여한다.
4: 그룹group과 기타 사용자others에게 읽기 권한을 부여한다.

{}
'{}'는 '-exec' 옵션에서 사용되며, 현재 검색된 파일의 경로를 참조하는 자리 표시자이다.

\;
'\;'는 '-exec' 옵션을 종료하고, 다음 파일로 넘어가도록 한다.

storage와 bootstrap/cache 디렉토리에 쓰기 권한을 설정한다.

```bash
sudo chmod -R 775 storage bootstrap/cache
```

6. Laravel 캐시 삭제

캐시cache는 자주 사용하는 데이터를 임시로 저장하여 애플리케이션 성능을 향상시킨다.
하지만 무언가를 수정했을 때 변경 사항을 적용시키기 위해서는 캐시를 지워야 한다.

```bash
# 모든 캐시 삭제
php artisan cache:clear

# 설정 캐시 삭제
php artisan config:cache

# 라우트 캐시 삭제
php artisan route:clear

# 뷰 캐시 삭제
php artisan view:clear

# 설정 캐시 다시 생성
php artisan config:cache
```

7. nginx 프로세스 재시작

```bash
sudo systemctl restart nginx 
```

'systemctl'
시스템 및 서비스 관리자를 제어하는 명령어로, systemd를 사용하여 시스템의 서비스를 관리한다.
systemd는 현대 리눅스 배포판에서 널리 사용되는 시스템 및 서비스 관리 데몬이다.

'restart'
'systemctl' 명령어의 하위 명령어로 지정된 서비스의 재시작을 수행한다.
서비스가 실행 중일 때 이를 중지하고 다시 시작하여, 서비스의 설정 변경, 문제 해결, 메모리 누수 방지, 로그 파일 업데이트 등의 작업을 적용한다.



이미지 안 뜰 때

```bash
php artisan storage:link
```